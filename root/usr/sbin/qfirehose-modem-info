#!/bin/sh

# 获取模组信息（模组名称、固件版本）
# 通过 AT 命令查询，需要 socat 工具
# 输出格式：每行一个 key=value

# 尝试的 AT 端口列表（优先 ttyUSB2，移远模组通常用 USB2 作 AT 口）
AT_PORTS="/dev/ttyUSB2 /dev/ttyUSB1 /dev/ttyUSB3 /dev/ttyUSB0"

# 检查 socat 是否可用
if ! command -v socat >/dev/null 2>&1; then
    echo "model=N/A"
    echo "firmware=N/A"
    echo "error=socat not found"
    exit 0
fi

# 发送 AT 命令并获取响应
send_at() {
    local port="$1"
    local cmd="$2"
    local result
    result=$(echo -e "${cmd}\r" | socat -T1 - "$port",crnl,rawer,nonblock=1,b115200,echo=0 2>/dev/null)
    echo "$result"
}

# 尝试各个端口
for port in $AT_PORTS; do
    [ -c "$port" ] || continue

    # 先测试端口是否响应
    resp=$(send_at "$port" "AT")
    echo "$resp" | grep -q "OK" || continue

    # 获取模组型号（ATI 命令）
    ati=$(send_at "$port" "ATI")
    model=$(echo "$ati" | sed -n '3p' | tr -d '\r')

    # 获取固件版本（AT+QGMR 或 AT+CGMR）
    gmr=$(send_at "$port" "AT+QGMR")
    if echo "$gmr" | grep -q "OK"; then
        firmware=$(echo "$gmr" | sed -n '2p' | tr -d '\r')
    else
        gmr=$(send_at "$port" "AT+CGMR")
        firmware=$(echo "$gmr" | sed -n '2p' | tr -d '\r')
    fi

    # 获取 IMEI（可选）
    imei_resp=$(send_at "$port" "AT+CGSN")
    if echo "$imei_resp" | grep -q "OK"; then
        imei=$(echo "$imei_resp" | sed -n '2p' | tr -d '\r')
    fi

    echo "model=${model:-N/A}"
    echo "firmware=${firmware:-N/A}"
    [ -n "$imei" ] && echo "imei=$imei"
    echo "port=$port"
    exit 0
done

# 没有找到可用端口
echo "model=N/A"
echo "firmware=N/A"
echo "error=No AT port found"
